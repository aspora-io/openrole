<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Candidate Dashboard - OpenRole</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0f766e',
                        secondary: '#14b8a6'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="/" class="text-2xl font-bold text-primary">OpenRole</a>
                    <div class="ml-10 flex items-baseline space-x-4">
                        <a href="/jobs" class="text-gray-700 hover:text-primary px-3 py-2 rounded-md text-sm font-medium">Browse Jobs</a>
                        <a href="/candidate-dashboard" class="bg-primary text-white px-3 py-2 rounded-md text-sm font-medium">Dashboard</a>
                        <a href="/applications" class="text-gray-700 hover:text-primary px-3 py-2 rounded-md text-sm font-medium">My Applications</a>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="user-name" class="text-gray-700 text-sm"></span>
                    <button onclick="logout()" class="text-gray-700 hover:text-primary text-sm">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Dashboard Content -->
    <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <!-- Welcome Section -->
        <div class="px-4 py-6 sm:px-0">
            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="px-4 py-5 sm:p-6">
                    <h1 class="text-2xl font-bold text-gray-900 mb-2">Welcome to your dashboard</h1>
                    <p class="text-gray-600 mb-4">Find your perfect job with transparent salary information.</p>
                    <div class="flex space-x-4">
                        <a href="/jobs" class="bg-primary text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-primary/90">Browse Jobs</a>
                        <a href="/cv-upload" class="border border-gray-300 text-gray-700 px-4 py-2 rounded-md text-sm font-medium hover:bg-gray-50">Upload CV</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="px-4 py-6 sm:px-0">
            <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-3">
                <!-- Profile Completion -->
                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <svg class="h-6 w-6 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                </svg>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 truncate">Profile Completion</dt>
                                    <dd class="text-lg font-medium text-gray-900">75%</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-50 px-5 py-3">
                        <div class="text-sm">
                            <a href="/profile" class="font-medium text-primary hover:text-primary/90">Complete your profile</a>
                        </div>
                    </div>
                </div>

                <!-- Applications -->
                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <svg class="h-6 w-6 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 truncate">Active Applications</dt>
                                    <dd class="text-lg font-medium text-gray-900" id="applications-count">0</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-50 px-5 py-3">
                        <div class="text-sm">
                            <a href="/applications" class="font-medium text-primary hover:text-primary/90">View all applications</a>
                        </div>
                    </div>
                </div>

                <!-- New Jobs -->
                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <svg class="h-6 w-6 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2-2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                </svg>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 truncate">New Jobs This Week</dt>
                                    <dd class="text-lg font-medium text-gray-900" id="new-jobs-count">12</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-50 px-5 py-3">
                        <div class="text-sm">
                            <a href="/jobs?filter=new" class="font-medium text-primary hover:text-primary/90">View new jobs</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Applications -->
        <div class="px-4 py-6 sm:px-0">
            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="px-4 py-5 sm:p-6">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Recent Applications</h3>
                    <div id="recent-applications">
                        <div class="text-center py-8 text-gray-500">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <p class="mt-2">No applications yet</p>
                            <a href="/jobs" class="mt-2 inline-block text-primary hover:text-primary/90">Start applying to jobs</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recommended Jobs -->
        <div class="px-4 py-6 sm:px-0">
            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="px-4 py-5 sm:p-6">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Recommended Jobs</h3>
                    <div id="recommended-jobs">
                        <div class="space-y-4">
                            <!-- Sample job card -->
                            <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h4 class="text-lg font-medium text-gray-900">Senior Software Engineer</h4>
                                        <p class="text-gray-600">OpenRole</p>
                                        <p class="text-sm text-gray-500 mt-1">South Dublin • Full-time</p>
                                        <p class="text-primary font-medium mt-2">€70,000 - €90,000</p>
                                    </div>
                                    <div class="text-right">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">New</span>
                                        <p class="text-sm text-gray-500 mt-2">2 days ago</p>
                                    </div>
                                </div>
                                <div class="mt-4 flex justify-between items-center">
                                    <div class="flex flex-wrap gap-2">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">TypeScript</span>
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">React</span>
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">Node.js</span>
                                    </div>
                                    <a href="/job-detail" class="text-primary hover:text-primary/90 text-sm font-medium">View Details</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/application-tracker.js"></script>
    <script>
        let currentUser = null;

        // Check authentication
        function checkAuth() {
            const token = localStorage.getItem('authToken');
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            
            if (!token || !user.id) {
                window.location.href = '/auth';
                return null;
            }
            
            // Check if user is candidate
            if (user.userType !== 'candidate') {
                window.location.href = '/employer-dashboard';
                return null;
            }
            
            // Display user name
            const displayName = `${user.firstName || 'User'} ${user.lastName || ''}`.trim();
            document.getElementById('user-name').textContent = displayName;
            
            currentUser = user;
            return user;
        }
        
        // Logout function
        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('user');
            window.location.href = '/';
        }
        
        // Load dashboard data
        function loadDashboardData() {
            if (!currentUser) return;
            
            try {
                // Get application statistics
                const stats = ApplicationTracker.getCandidateStats(currentUser.id);
                
                // Update applications count
                document.getElementById('applications-count').textContent = stats.total;
                
                // Load recent applications
                loadRecentApplications();
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        // Load recent applications
        function loadRecentApplications() {
            if (!currentUser) return;

            const recentApplications = ApplicationTracker.getRecentApplications(5, currentUser.id, 'candidate');
            const container = document.getElementById('recent-applications');
            
            if (recentApplications.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <p class="mt-2">No applications yet</p>
                        <a href="/jobs" class="mt-2 inline-block text-primary hover:text-primary/90">Start applying to jobs</a>
                    </div>
                `;
                return;
            }

            // Render applications
            container.innerHTML = recentApplications.map(app => {
                const status = ApplicationTracker.getStatusDisplay(app.status);
                const appliedDate = new Date(app.appliedAt).toLocaleDateString('en-GB', {
                    day: 'numeric',
                    month: 'short',
                    year: 'numeric'
                });

                return `
                    <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h4 class="text-lg font-medium text-gray-900">${app.jobTitle}</h4>
                                <p class="text-gray-600">${app.jobCompany}</p>
                                <p class="text-sm text-gray-500 mt-1">${app.jobLocation} • ${app.jobSalary}</p>
                                <p class="text-xs text-gray-400 mt-2">Applied on ${appliedDate}</p>
                            </div>
                            <div class="flex flex-col items-end ml-4">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-${status.color}-100 text-${status.color}-800">
                                    ${status.icon} ${status.label}
                                </span>
                                <button onclick="viewApplication('${app.id}')" class="text-sm text-primary hover:text-primary/90 mt-2">
                                    View Details
                                </button>
                            </div>
                        </div>
                        
                        <!-- Status Timeline (simplified) -->
                        <div class="mt-4 pt-4 border-t border-gray-100">
                            <div class="flex items-center text-xs text-gray-500">
                                <span class="mr-2">Status History:</span>
                                ${app.statusHistory.slice(-2).map(status => `
                                    <span class="mr-3">${status.status} (${new Date(status.timestamp).toLocaleDateString()})</span>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // View application details
        function viewApplication(applicationId) {
            // In a real app, this would navigate to a detailed application view
            const applications = ApplicationTracker.getApplications();
            const application = applications.find(app => app.id === applicationId);
            
            if (application) {
                alert(`Application Details:\n\nJob: ${application.jobTitle}\nCompany: ${application.jobCompany}\nStatus: ${application.status}\nApplied: ${new Date(application.appliedAt).toLocaleDateString()}\nApplication ID: ${application.id}`);
            }
        }

        // Generate sample data for testing (remove in production)
        function generateSampleData() {
            if (!currentUser) return;
            
            // Only generate if no applications exist
            const existingApps = ApplicationTracker.getCandidateApplications(currentUser.id);
            if (existingApps.length === 0) {
                ApplicationTracker.generateSampleData(currentUser.id, 'emp_techcorp_001');
                loadDashboardData(); // Reload to show the new data
            }
        }

        // Listen for application events to update dashboard in real-time
        document.addEventListener('applicationSubmitted', function(event) {
            loadDashboardData();
        });

        document.addEventListener('applicationStatusUpdated', function(event) {
            loadDashboardData();
        });
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            const user = checkAuth();
            if (user) {
                loadDashboardData();
                
                // Generate sample data for demonstration
                setTimeout(generateSampleData, 100);
            }
        });
    </script>
</body>
</html>